/*
████████████████████████████████████████████████████████████████████████████████████████████████████
████████████████████████████████████████████████████████████████████████████████████████████████████
████████████████████████████████████████████████████████████████████████████████████████████████████
████████████████████████████████████████████████████████████████████████████████████████████████████
████████████████████████████████████████████████████████████████████████████████████████████████████
████████████████████████████████████████████████████████████████████████████████████████████████████
████████████████████████████████████████████████████████████████████████████████████████████████████
██████████████████████████████████████████▂▂▂▂▂▂▂▂▂▂▂███████████████████████████████████████████████
████████████████████████████████████▇▃▉▎▏▏           ▏▏▏▊▄▇█████████████████████████████████████████
██████████████████████████████████▇▁▎                     ▏▋▆███████████████████████████████████████
█████████████████████████████████▃▎                         ▏▉██████████████████████████████████████
████████████████████████████████▂                            ▏▁▇████████████████████████████████████
███████████████████████████████▃▏                              ▉████████████████████████████████████
██████████████████████████████▃▎  ▎▊▂▄▁▎               ▏▌▁▃▄▋  ▏▂███████████████████████████████████
██████████████████████████████▊  ▌▅▍▍██▆▍              ▄▋ ▄██▂  ▋███████████████████████████████████
██████████████████████████████▊  ▋██████▍              ▇█████▅  ▋███████████████████████████████████
██████████████████████████████▊  ▏▉▇██▇▉▏ ▏▏▋▊▊▊▊▊▊▍▏  ▌▇███▆▍  ▌███████████████████████████████████
█████████████████████████████▃▍    ▍▋▋▍ ▏▋▉▊▍   ▏▌▍▅▄▂▌ ▏▋▋▋▏   ▎▃██████████████████████████████████
█████████████████████████████▊     ▎▍▍▊▉▊▌▏▂▁     ▊▄▌▁▅▄▉▍▍▍     ▌▇█████████████████████████████████
█████████████████████████████▊    ▉▋▍▍▎    ▏▏     ▏▏▏ ▎▊▃▆▇█▄▎   ▎▆█████████████████████████████████
█████████████████████████████▃▎   ▆▋▌▉▍▏ ▏    ▏ ▏▏▏▏▏   ▊▁▆█▇▍  ▏▂██████████████████████████████████
██████████████████████████████▅▊▏ ▏▊▅▅▇▃▃▆▆▃▂▂▃▅▅▅████▃▅█▅▅▁▎  ▍▄███████████████████████████████████
████████████████████████████████▅▊▍   ▉███▆▅▅▅▅▅▅▅▅▅▇███▄   ▏▋▃█████████████████████████████████████
██████████████████████████████████▇▅▉▏▏▎▂█▆▄▄▅▅▅▅▅▅▅██▄▍▎ ▋▆▆███████████████████████████████████████
██████████████████████████████████████   ▏▎▍▌▁▉▉▄▅▂▊▉▍▏  ▃██████████████████████████████████████████
██████████████████████████████████████                 ▏▏▃██████████████████████████████████████████
████████████████████████████████████▅▌                 ▏▏▊▇█████████████████████████████████████████
██████████████████████████████████▇▊▎                    ▏▎▁▇██████████████▆▋▁██████████████████████
███████████████████████████████▃▁▏▏                         ▏▏▌▂▂▄▇██████▆▂▍ ▏▊▇████████████████████
███████████████████████████▄▉▁▉▎                                               ▄████████████████████
█████████████████████████▆▌▏▊▊                          ▌▊▊▊▊▊▊▊▊▊▊▌▏         ▏▃████████████████████
█████████████████████████▎▎▁▊                         ▏▁▌▏        ▎▍▉▉▉▉▉▉▉▍   ▏▇███████████████████
████████████████████████▌▏▂▋                         ▏▄▏             ▏▏   ▏▆▊   ▇███████████████████
████████████████████████▍▄▋                          ▎▄                    ▅▊  ▋▇███████████████████
████████████████████████▍▆                           ▎▅                   ▍▅▍  ▆████████████████████
████████████████████████▍▋                           ▏▋▂                ▏▋█▋  ▎▆████████████████████
████████████████████████▃▁                            ▏▍▃▋▏▏           ▎▂▂▍  ▏▄█████████████████████
█████████████████████████▅▉                             ▏▌▉▁▉▉▁▁▁▁▁▂▂▁▉▊▎   ▍▇██████████████████████
█████████████████████████▆▅                                   ▏▎▎▏▏▎▌    ▏▎▁▅███████████████████████
██████████████████████████▆▋▍                                          ▏▏▎▃▇████████████████████████
████████████████████████████▇▉▎                                     ▏  ▋▃█▇█████████████████████████
█████████████████████████████▇██▃▂▃▁▊▎  ▏▏  ▏         ▏▏▏▏▏▏▉▉▍▍▉▉▎▎▋▁▇█▇███████████████████████████
█████████████████████████████████████▆▂▃▃▁▉▋▋▋▋▋▋▋▋▋▋▋▊▂▆▇▄▂▇█▇▅▂▂▆▅▅▇██████████████████████████████
████████████████████████████████████████████████████████████████████████████████████████████████████
████████████████████████████████████████████████████████████████████████████████████████████████████
████████████████████████████████████████████████████████████████████████████████████████████████████
████████████████████████████████████████████████████████████████████████████████████████████████████
████████████████████████████████████████████████████████████████████████████████████████████████████
████████████████████████████████████████████████████████████████████████████████████████████████████
████████████████████████████████████████████████████████████████████████████████████████████████████

psAI-Ducky — ESP32-S2 HID MCP Bridge
(c) 2025 Howie Duhzit — HowieDuhzit.Best — @HowieDuhzit — Contact@HowieDuhzit.Best
*/

#include <Arduino.h>
#include <WiFi.h>
#include <WebSocketsServer.h>
#include <ArduinoJson.h>

#if HAVE_NATIVE_USB
#include "USB.h"
#include "USBHIDKeyboard.h"
#include "USBHIDMouse.h"
#endif

#include "config.h"
#include "mcp_server.h"
#include "hid_controller.h"
#include "ble_hid_controller.h"
#include "wifi_manager.h"
#include "ota_manager.h"
#include "web_server.h"
#include "gamepad_controller.h"
#include "macro_manager.h"
#include "keyboard_layout.h"

// Global objects
WebSocketsServer webSocket(MCP_SERVER_PORT);

#if HAVE_NATIVE_USB
USBHIDKeyboard keyboard;
USBHIDMouse mouse;
#endif

// MCP and HID controllers
MCPServer mcpServer(&webSocket);
WiFiManager wifiManager;
OTAManager otaManager;
ConfigWebServer webServer(80);
GamepadController gamepadController;
MacroManager macroManager;
KeyboardLayoutManager layoutManager;

#if !HAVE_NATIVE_USB
// BLE HID for non-USB boards
BLEHIDController bleHIDController("psAI-Ducky");
#endif

void setup() {
    // Initialize Serial for debugging
    Serial.begin(115200);
    delay(2000); // Longer delay for serial to stabilize
    Serial.println("ESP32 MCP Server MINIMAL TEST starting...");
    Serial.flush();
    
#if HAVE_NATIVE_USB
    // Initialize native USB and HID
    Serial.println("Initializing USB HID...");
    USB.begin();
    keyboard.begin();
    mouse.begin();
#endif

    // Initialize WiFi Manager
    Serial.println("Initializing WiFi Manager...");
    wifiManager.begin();
    Serial.println("WiFi Manager initialized");
    
    // Try to connect to WiFi
    Serial.println("Attempting WiFi connection...");
    if (!wifiManager.connect()) {
        Serial.println("WiFi connection failed, starting AP...");
        wifiManager.startAccessPoint();
    } else {
        Serial.println("WiFi connected successfully!");
        Serial.printf("IP Address: %s\n", WiFi.localIP().toString().c_str());
        Serial.printf("Gateway: %s\n", WiFi.gatewayIP().toString().c_str());
        Serial.printf("Subnet: %s\n", WiFi.subnetMask().toString().c_str());
        Serial.printf("DNS: %s\n", WiFi.dnsIP().toString().c_str());
        Serial.printf("SSID: %s\n", WiFi.SSID().c_str());
        Serial.printf("Signal Strength: %d dBm\n", WiFi.RSSI());
        Serial.printf("MAC Address: %s\n", WiFi.macAddress().c_str());
    }
    
#if HAVE_NATIVE_USB
    // Initialize USB HID controller
    static HIDController hidController(&keyboard, &mouse);
    hidController.begin();
    mcpServer.setHIDController(&hidController);
#else
    // Initialize BLE HID controller for non-USB boards
    bleHIDController.begin();
    // TODO: Integrate BLE HID with MCP server
#endif

    // Initialize OTA after WiFi is connected
    Serial.println("Initializing OTA Manager...");
    otaManager.begin("psai-ducky", nullptr);  // No password by default
    Serial.println("OTA Manager initialized");
    Serial.println("OTA updates available via Arduino IDE or platformio");
    
    // Initialize web server
    Serial.println("Initializing Web Server...");
    webServer.begin();
    Serial.println("Web Server initialized");
    
    // Initialize gamepad controller
#if HAVE_NATIVE_USB
    Serial.println("Initializing Gamepad Controller...");
    gamepadController.begin();
    Serial.println("Gamepad Controller initialized");
#endif
    
    // Initialize macro manager
    Serial.println("Initializing Macro Manager...");
    macroManager.begin();
    Serial.println("Macro Manager initialized");
    
    // Initialize keyboard layout manager
    Serial.println("Initializing Keyboard Layout Manager...");
    layoutManager.begin();
    Serial.println("Keyboard Layout Manager initialized");

    // Initialize MCP Server
    Serial.println("Initializing MCP Server...");
    mcpServer.begin();
    Serial.println("MCP Server initialized");
    Serial.printf("WebSocket server listening on port %d\n", MCP_SERVER_PORT);
    if (WiFi.status() == WL_CONNECTED) {
        Serial.printf("WebSocket URL: ws://%s:%d\n", WiFi.localIP().toString().c_str(), MCP_SERVER_PORT);
    }
    Serial.println("MINIMAL SETUP COMPLETE!");
}

void loop() {
    // Handle WebSocket connections
    webSocket.loop();
    
    // Handle WiFi management
    wifiManager.loop();
    
    // Handle OTA updates
    otaManager.loop();
    
    // Handle web server
    webServer.loop();
    
    // Handle macro playback
    macroManager.update();
    
    // Handle MCP server tasks
    mcpServer.loop();
    
    // Small delay to prevent watchdog issues
    delay(1);
}
